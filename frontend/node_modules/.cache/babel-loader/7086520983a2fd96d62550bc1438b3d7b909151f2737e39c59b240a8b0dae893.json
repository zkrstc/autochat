{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.iterator.some.js\";\n/******************************************************************************\n * Copyright 2021 TypeFox GmbH\n * This program and the accompanying materials are made available under the\n * terms of the MIT License, which is available in the project root.\n ******************************************************************************/\nimport { getDocument } from '../utils/ast-utils.js';\nimport { ContextCache } from '../utils/caching.js';\nimport { CancellationToken } from '../utils/cancellation.js';\nimport { stream } from '../utils/stream.js';\nimport { UriUtils } from '../utils/uri-utils.js';\nexport class DefaultIndexManager {\n  constructor(services) {\n    /**\n     * The symbol index stores all `AstNodeDescription` items exported by a document.\n     * The key used in this map is the string representation of the specific document URI.\n     */\n    this.symbolIndex = new Map();\n    /**\n     * This is a cache for the `allElements()` method.\n     * It caches the descriptions from `symbolIndex` grouped by types.\n     */\n    this.symbolByTypeIndex = new ContextCache();\n    /**\n     * This index keeps track of all `ReferenceDescription` items exported by a document.\n     * This is used to compute which elements are affected by a document change\n     * and for finding references to an AST node.\n     */\n    this.referenceIndex = new Map();\n    this.documents = services.workspace.LangiumDocuments;\n    this.serviceRegistry = services.ServiceRegistry;\n    this.astReflection = services.AstReflection;\n  }\n  findAllReferences(targetNode, astNodePath) {\n    const targetDocUri = getDocument(targetNode).uri;\n    const result = [];\n    this.referenceIndex.forEach(docRefs => {\n      docRefs.forEach(refDescr => {\n        if (UriUtils.equals(refDescr.targetUri, targetDocUri) && refDescr.targetPath === astNodePath) {\n          result.push(refDescr);\n        }\n      });\n    });\n    return stream(result);\n  }\n  allElements(nodeType, uris) {\n    let documentUris = stream(this.symbolIndex.keys());\n    if (uris) {\n      documentUris = documentUris.filter(uri => !uris || uris.has(uri));\n    }\n    return documentUris.map(uri => this.getFileDescriptions(uri, nodeType)).flat();\n  }\n  getFileDescriptions(uri, nodeType) {\n    var _a;\n    if (!nodeType) {\n      return (_a = this.symbolIndex.get(uri)) !== null && _a !== void 0 ? _a : [];\n    }\n    const descriptions = this.symbolByTypeIndex.get(uri, nodeType, () => {\n      var _a;\n      const allFileDescriptions = (_a = this.symbolIndex.get(uri)) !== null && _a !== void 0 ? _a : [];\n      return allFileDescriptions.filter(e => this.astReflection.isSubtype(e.type, nodeType));\n    });\n    return descriptions;\n  }\n  remove(uri) {\n    const uriString = uri.toString();\n    this.symbolIndex.delete(uriString);\n    this.symbolByTypeIndex.clear(uriString);\n    this.referenceIndex.delete(uriString);\n  }\n  async updateContent(document, cancelToken = CancellationToken.None) {\n    const services = this.serviceRegistry.getServices(document.uri);\n    const exports = await services.references.ScopeComputation.computeExports(document, cancelToken);\n    const uri = document.uri.toString();\n    this.symbolIndex.set(uri, exports);\n    this.symbolByTypeIndex.clear(uri);\n  }\n  async updateReferences(document, cancelToken = CancellationToken.None) {\n    const services = this.serviceRegistry.getServices(document.uri);\n    const indexData = await services.workspace.ReferenceDescriptionProvider.createDescriptions(document, cancelToken);\n    this.referenceIndex.set(document.uri.toString(), indexData);\n  }\n  isAffected(document, changedUris) {\n    const references = this.referenceIndex.get(document.uri.toString());\n    if (!references) {\n      return false;\n    }\n    return references.some(ref => !ref.local && changedUris.has(ref.targetUri.toString()));\n  }\n}","map":{"version":3,"names":["getDocument","ContextCache","CancellationToken","stream","UriUtils","DefaultIndexManager","constructor","services","symbolIndex","Map","symbolByTypeIndex","referenceIndex","documents","workspace","LangiumDocuments","serviceRegistry","ServiceRegistry","astReflection","AstReflection","findAllReferences","targetNode","astNodePath","targetDocUri","uri","result","forEach","docRefs","refDescr","equals","targetUri","targetPath","push","allElements","nodeType","uris","documentUris","keys","filter","has","map","getFileDescriptions","flat","_a","get","descriptions","allFileDescriptions","e","isSubtype","type","remove","uriString","toString","delete","clear","updateContent","document","cancelToken","None","getServices","exports","references","ScopeComputation","computeExports","set","updateReferences","indexData","ReferenceDescriptionProvider","createDescriptions","isAffected","changedUris","some","ref","local"],"sources":["../../src/workspace/index-manager.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}